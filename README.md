# rag-challenge-2025 by HalykBank


RAG-пайплайн для PDF/XLSX, который:
1) парсит документы и нормализует их в единую схему,  
2) индексирует фрагменты (FAISS + TF-IDF),  
3) достаёт кандидатов и делает **LLM-rerank**,
4) приводит числа и **мерджит** несколько прогонов в финальный результат.

---


## Решение (по этапам)

### 1) Подготовка и парсинг корпуса (скрипт build_context.py)
- На вход — каталог с документами (`.pdf`, `.xlsx`).
- PDF парсятся PyMuPDF(также есть поддержка docling); при необходимости подключается гибридный режим с OCR/vision (если на странице недостаточно символов, меньше 1000, то извлекаем страницу и прогоняем через OCR OpenAI) и завершаем выбором наиболее длинного текста на страницу.
- XLSX разбираются отдельно (в т.ч. табличные данные).
- Результат приводится к **единой V1-схеме JSON** (страницы → текстовые блоки), чтобы все последующие шаги работали на одном формате.

### 2) Индексация (по документам) (скрипт build_context.py)
- Конфигурация пайплайна разнесена по сущностям: `Parse/Chunking/Embedding/Hybrid/Indexer/Retriever/Rerank`.
- Чанкинг **auto** с `min/max tokens` и `overlap`.
- Эмбеддинги OpenAI(батчами) → **FAISS** (косинусная близость).
- Параллельно строится лексический индекс **TF-IDF**.  
  В папку индекса кладутся: `faiss.index`, `meta.pkl`, `tfidf.pkl`.

### 3) Поиск (retrieval) и LLM-rerank (скрипт build_context.py)
- Запрос эмбеддится, top-K кандидатов берутся из FAISS.
- Если включён гибрид, смешиваются dense (FAISS) и sparse (TF-IDF) с весами `HybridConfig`.
- Затем **LLM-rerank**: компактная модель выставляет релевантность `[0..1]` по строгой шкале, итоговый скор взвешенно смешивается с FAISS (оставил: **0.85 LLM / 0.15 FAISS**).  
  Обычно используется `pre_rerank_k=100` → срез до финального `top_k`.

### 4) Подготовка контекста LLM (скрипт build_context.py)
- Собирается «snippets block» из top-чанков (документ/страница/фрагмент).
- Рендер **первой подходящей страницы** в PNG, чтобы модель видела ровно ту страницу, откуда пришёл самый важный чанк.
- Извлечение целой страницы из JSON для самого важного чанка.

### 5) Оркестрация инференса  (скрипт inference.py)
- Вопросы читаются из XLSX; обработка — батчами через `ThreadPoolExecutor`.
- Помимо ответа получаем информацию о чанке, на основе которого дан ответ.
- Сохранение ответов в JSON.
- **Numeric-fix**: строковые «1 234,56» → числа (`int/float`) по правилам локали; «—»/«N/A» → `None`.

### 6) Мини-аугментация вопросов (скрипты inference.py/question_augment.py)
- Лёгкий модуль на правилах: если вопрос начинается с «Сколько / Какова / Число / Количество / На какую дату» и **нет** «всего/итого/общее/…», добавляется точечное уточнение (например, «всего»).
- Есть пакетная правка XLSX: поиск колонки «question/вопрос», запись изменений и отчёт о диффе.  
  Это можно включить как **предшаг** основного инференса.

- Пример: 
```
[augment][ok] 'Сколько физлиц нерезидентов среди аффилированных лиц у АО "ЛОТТЕ Рахат"?' -> 'Сколько всего физлиц нерезидентов среди аффилированных лиц у АО "ЛОТТЕ Рахат"?'
```

### 7) Слияние уточнений и повторных прогонов (merge_and_judge.py)
- Собираем все ответы-уточнения по `question_id` из нескольких JSON и выбираем лучший итог:  
  • если **все числовые** — берём **максимум**;  
  • если **списки** — объединяем **уникальные** элементы, сохраняя порядок **первого появления**;  
  • если одни варианты — **подстроки** другого — берём **самый информативный** (длинный);  
  • иначе — нормализованное **голосование по частоте**.  
  При этом сохраняем исходный **тип ответа** (`int/float/str/bool/list…`).
- Драйвер мерджа тянет «базовый» JSON, подмешивает уточнения, протоколирует изменения и пишет объединённый результат.

### 8) Хелперы и защита формата (helpers.py)
- Нормализация `parsed` JSON (варианты схем → V1).
- Приведение строк к числам, «чинка» поля `answer` в итоговом JSON.
- Утилиты изолированы, чтобы не дублировать логику.

### 9) Скрипты-обвязки (entry-points)
- `build_dataset.py` — прогон: **парсинг (PDF/XLSX) → нормализация → индексация**. Флаги `SKIP_PARSING` / `SKIP_INDEXING`. Ключ OpenAI берётся из окружения.
- `inference.py` — сборка `retriever + rerank`, (опционально) **аугментация вопросов**, параллельные ответы, сохранение JSON и **numeric-fix**.
- `question_augment.py` — локальные правила +/или GPT-аугментор.
- `merge_and_judge.py` — слияние нескольких JSON-выходов в финальную версию.
- `helpers.py` — конвертеры, нормализация, приведение типов.
- `pipeline.py` — интегрированный пайплайн(экспорт API).


### Также было использовано, но упразднено в финальном решении
### 1) Ансамбль ответов (text-LLM + vision-LLM + judge) 
- «Главный раннер» проходит по строкам входного Excel: `id / full_question / answer_type`.
- **Кандидат A (text-LLM)** отвечает по сниппетам + текст страницы;  
  **Кандидат B (vision-LLM)** — по сниппетам **+** PNG-снимку страницы.  
  **Судья (judge)** выбирает лучший/синтезирует короткий ответ по жёстким правилам и отдаёт типизированный JSON.

---


Пример работы:

```markdown
QID 4
Q: В скольких месяцах 2024 года добыча руды превысила 5 млн тонн у ТОО "Bass Gold"?
Type: int
Models -> text=gpt-5 vision=gpt-4o judge=gpt-4o
--------------------------------------------------------------------------------
Top hits:
[1] fpstp_2024_rus p.28 score=0.9329 | BASS Gold Операционная деятельность В 2024 году ТОО «BASS Gold» завершило ключевой этап технологического и организационного перехода к глубокой переработке золоторудного сырья. Основным результатом периода стало завершен…
[2] fpstp_2024_rus p.6 score=0.8471 | добыча золотосодержащей руды Ключевые показатели за 2024 год 56 128,07 тонн Концентрат Объемы реализации готовой продукции, тонн: 307,43 тонн среднее содержание золота в руде 2,17 грамм/тонна Среднее содержание золота на…
[3] bastp_2024_rus p.10 score=0.5775 | Годовой отчет 2024 г. АО «БАСТ» РАЗДЕЛ I. О КОМПАНИИ 10 ОПИСАНИЕ ТЕХНОЛОГИИ ПРОИЗВОДСТВА И ПРОИЗВОДСТВЕННОГО ЦИКЛА АО «БАСТ» оперирует горно-обогатительным комбинатом по переработке руды флотационным способом производите…
[4] fpstp_2024_rus p.32 score=0.4975 | В 2025 году компания планирует не только сохранить текущие объёмы, но и нарастить добычу и переработку, с выходом на устойчивую рентабельность и улучшение ключевых финансовых показателей. Производственная себестоимость в…
[5] fpstp_2024_rus p.31 score=0.4969 | гии обогащения к свойствам руды месторождения Ушшокы, что потребовало больше времени для вывода перерабатывающих мощностей на плановые показатели. Вместе с тем, к концу 2024 года компания смогла существенно повысить пока…
[6] fpstp_2024_rus p.94 score=0.4963 | ства Республики Казахстан продлило лицензию на проведение геологоразведочных работ на месторождении «Чинасыл-сай» до 24 декабря 2030 года. Товарищество с ограниченной ответственностью «BASS Gold»; Юридический адрес: Респ…
[7] fpstp_2024_rus p.30 score=0.4961 |  компания рассматривает вопрос внедрения современного оборудования автоматической сортировки руды. На момент формирования годового отчета были изучен соответствующий рынок передовых технологий и направлены в КНР для лабо…
[8] fpstp_2024_rus p.31 score=0.4951 | Помимо влияния внешних факторов, основной причиной отрицательного финансового результата компании за 2024 год стал значительный рост операционных и прочих расходов. В отличие от 2023 года, когда компания получила прибыль…
[9] fpstp_2024_rus p.31 score=0.4946 | я за счёт собственной переработки. В отчетном периоде ТОО «BASS Gold» вело активную добычную деятельность, осуществляла запуск и адаптацию новой технологической линии, проводило геологоразведочные работы и продолжило нео…
[10] fpstp_2024_rus p.26 score=0.4917 | P00009707 (FPSTb1) в сумме 269 000 долларов США 2 февраля 2024 года Основные события отчетного периода Февраль Апрель заключение договора с ТОО «Тау-Кен Алтын» на поставку сплава Доре 6 февраля 2024 года запуск золотоизв…
[11] fpstp_2024_rus p.58 score=0.4908 | 023 года доля участия составляла 99,99 %). Компания и дочерняя организация вместе именуются как Группа. На 31 декабря 2024 года ТОО «BASS HOLDING» владело 99,99% доли участия в материнской компании Группы, Садвакасов Чин…
[12] fpstp_2024_rus p.30 score=0.4906 | спективу: 1. Программа диверсификации производства готовой продукции • строительство фабрики с технологией флотационного обогащения руды мощностью 6000 тонн переработки сырья в месяц. На момент подготовки настоящего отче…
[13] fpstp_2024_rus p.30 score=0.4904 | Главными приоритетами компании в этой отрасли на долгосрочный период неизменно остаются внедрение новых технологий, расширение сырьевой базы и развитие производств глубокой переработки с выпуском продукции с добавленной …
[14] fpstp_2024_rus p.31 score=0.4899 | азрабатывается с 70-х годов прошлого столетия, на данном месторождении имеется тенденция к естественному снижению содержания драгоценного металла в добываемой руде. При этом, в ходе отработки рабочих блоков встречается р…
[15] fpstp_2024_rus p.26 score=0.4885 | Прежде всего, сохраняется сильная фундаментальная поддержка спроса на золото со стороны глобальных факторов: инфляционные ожидания, политическая нестабильность в ряде регионов мира, а также переход части стран к стратеги…
--------------------------------------------------------------------------------
Text ans:   5
Vision ans: None
Judge -> chosen=text reason=
Used chunk: fpstp_2024_rus:28
```
